<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, user-scalable=no">
		<title></title>
		<link rel="stylesheet" href="__CSS__/put.css" />
	</head>
	<body>
	<div class="header">
		<a href="javascript:history.go(-1)"><img src="__IMG__/back.png" class="back"></a>投放广告
	</div>
	<div class="main">
		<div class="titleDiv">
			<img src="__IMG__/logo-1.png">
			注：时间段不同价位不同，图片与视频价位也不同有投资才有回报
		</div>
		<div class="portion1">
			<p class="title1">选择类型</p>
			<div class="select">
				<div class="current" id="pic">图片广告</div>
				<input type="hidden" id="pic_price" value="{$pic_price}">
				<div id="video">视频广告</div>
				<input type="hidden" id="video_price" value="{$video_price}">
				<input type="hidden" id="profit_cons_beans" value="{$profit_cons_beans}">
			</div>
			<p class="title2">购买数量</p>
			<div class="addBox">
				<div class="minus" id="dec">-</div>
				<div class="number" id="number"></div>
				<div class="add" id="inc">+</div>
			</div>
		</div>
		<p class="title3">编辑标题</p>
		<textarea class="textarea"  id='desc' placeholder="输入文案..."></textarea>
		<p class="title3">编辑文案</p>
		<textarea class="textarea" id='description' placeholder="输入文案..."></textarea>
		
		
		
	    <div class="uploading">
	    	<div class="upload_img_wrap">
				<div id="imgBox"></div>
				<img class="upload_img" data-id="1" src="__IMG__/upload_img.png" />
				<img style="display:none" class="upload_img" data-id="2" src="__IMG__/upload_img.png" />
				<img style="display:none" class="upload_img" data-id="3" src="__IMG__/upload_img.png" />
			</div>


	        <div style="display: none;width: 100%;height: 100%;position: relative;">
				<form id="upBox" class="upload_form" action="" method="post" enctype="multipart/form-data">
					<div style="display: none;" id="inputBox">
						<input type="file" name="image[]" data-id="1" title="请选择图片" id="file1" accept="image/png,image/jpg,image/gif,image/JPEG" />
						<input type="file" name="image[]" data-id="2" title="请选择图片" id="file2" accept="image/png,image/jpg,image/gif,image/JPEG" />
						<input type="file" name="image[]" data-id="3" title="请选择图片" id="file3" accept="image/png,image/jpg,image/gif,image/JPEG" /> 点击选择图片
					</div>
					<input style="display:none" type="submit" id="sub" />
				</form>
			</div>
	    </div>
			
		
		<div class="total">
			<span id="ywd">消耗悦玩豆:0个</span>
			<span id="total">总计:¥0.0</span>
			<div class="payBtn">去结算</div>
		</div>
		<div class="pop" style="display: none">
			<div class="footer">
				<img src="__IMG__/del_img.png" class="close">
				<p class="p1" id="num1">你需要消费3个币</p>
				<p class="p2" id="num2">3币</p>
				<p class="p3">(1元=1币)</p>
				<div class="payBtn1">购买</div>
				<div class="bottom">
					<span>币会升值哦</span>
					<a href="###">点击了解</a>
				</div>
		    </div>
		</div>
		
	</div>
	</body>
	<script type="text/javascript" src="__JS__/jquery-3.2.1.min.js" ></script>
	<script src="__JS__/layer.js"  type="text/javascript" ></script>
	<script>
		var imgNum = 0;
		$(".upload_img_wrap .upload_img").bind("click", function(ev) {
			//console.log(ev.currentTarget.dataset.id)
			var index = ev.currentTarget.dataset.id;
			var that = this;
			if(index == 1) {
				$("#file1").click();
				$("#file1").unbind().change(function(e) {
					var index = e.currentTarget.dataset.id;
					if($('#file').val() == '') {
						return false;
					}
					$(that).hide();
					var filePath = $(this).val();
					changeImg(e, filePath, index);
					
					imgNum++;
					if(imgNum<3){
						$(".upload_img").eq(1).show();
					}
					$(".upload_img_length").html(imgNum);
				})
			} else if(index == 2) {
				$("#file2").click();
				$("#file2").unbind().change(function(e) {
					var index = e.currentTarget.dataset.id;
					if($('#file').val() == '') {
						return false;
					}
					$(that).hide();
					var filePath = $(this).val();
					changeImg(e, filePath, index);
					
					imgNum++;
					if(imgNum<3){
						$(".upload_img").eq(2).show();
					}
					$(".upload_img_length").html(imgNum);
				})
			} else if(index == 3) {
				$("#file3").click();
				$("#file3").unbind().change(function(e) {
					var index = e.currentTarget.dataset.id;
					if($('#file').val() == '') {
						return false;
					}
					var filePath = $(this).val();
					changeImg(e, filePath, index);
					$(that).hide();
					imgNum++;
					$(".upload_img_length").html(imgNum);
				})
			}
		})

		function changeImg(e, filePath, index) {
			fileFormat = filePath.substring(filePath.lastIndexOf(".")).toLowerCase();
			//检查后缀名
			if(!fileFormat.match(/.png|.jpg|.jpeg/)) {
				showError('文件格式必须为：png/jpg/jpeg');
				return;
			}
			//获取并记录图片的base64编码
			var reader = new FileReader();
			reader.readAsDataURL(e.target.files[0]);
			reader.onloadend = function() {
				// 图片的 base64 格式, 可以直接当成 img 的 src 属性值        
				var dataURL = reader.result;
				// console.log(dataURL)
				// 显示图片
				$("#imgBox").html($("#imgBox").html() + '<div class="imgContainer" data-index=' + index + '><img   src=' + dataURL + ' onclick="imgDisplay(this)"><img onclick="removeImg(this,' + index + ')"  class="imgDelete" src="__IMG__/del_img.png" /></div>');
			};

		}

		function removeImg(obj, index) {
			for(var i = 0; i < $(".imgContainer").length; i++) {
				if($(".imgContainer").eq(i).attr("data-index") == index) {
					$(".imgContainer").eq(i).remove();
				}
			}
			for(var i = 0; i < $(".upload_img").length; i++) {
				$(".upload_img").eq(i).hide();
				if($(".upload_img").eq(i).attr("data-id") == index) {
					// console.log($(".upload_img").eq(i).attr("data-id"))
					$(".upload_img").eq(i).show();
				}
			}
			imgNum--;
			$(".upload_img_length").html(imgNum);
		}
		
		
		function imgDisplay(obj) {
			var src = $(obj).attr("src");
			var imgHtml = '<div style="width: 100%;height: 100%;overflow: auto;background: rgba(0,0,0,0.5);text-align: center;position: fixed;top: 0;left: 0;z-index: 1000;display: flex;justify-content: center;    align-items: center;"><img src=' + src + ' style="margin-top: 100px;width: 96%;margin-bottom: 100px;"/><p style="font-size: 50px;position: fixed;top: 30px;right: 30px;color: white;cursor: pointer;" onclick="closePicture(this)">×</p></div>'
			$('body').append(imgHtml);
		}
		
		function closePicture(obj) {
			$(obj).parent("div").remove();
		}
		
		
		$(".select div").click(function(){
			$(".select div").removeClass("current");
			$(this).addClass("current");
		})
		
		
		var numbers=0;
        $(".number").html(numbers);		
		$(".minus").click(function(){
			if(numbers>0){
				numbers--;
			}
			$(".number").html(numbers);
		})
		$(".add").click(function(){			
				numbers++;
				$(".number").html(numbers);
		})
		$(".close").click(function(){
			$(".pop").hide()
		})
		$(".payBtn").click(function(){
			var type;
			var type_value = $(".current").html();
			if(type_value == '图片广告'){
				type = 1;
			}else{
				type = 2;
			}
			var number = $(".number").html();
			var description = $("#description").val();
			var desc = $("#desc").val();
			var images1 = document.getElementById("file1").files;
			var images2 = document.getElementById("file2").files;
			var images3 = document.getElementById("file3").files;
			var formData = new FormData();
			formData.append('type',type);
			formData.append('number',number);
			formData.append('description',description);
			formData.append('desc',desc);
			formData.append('images[]',images1[0]);
			formData.append('images[]',images2[0]);
			formData.append('images[]',images3[0]);
			if(!(type && number && description && desc && images1[0])){
				layer.msg('请完整的填写相关信息');
				return;
			}
		layer.confirm('确认购买吗？',{icon:3,title:'提示'},function(){
				$.ajax({
					url:"put",
					type:"post",
					data:formData,
					contentType:false,
					processData:false,
					success:function(res){
						if(res.code == 1){
							// alert(res.msg);
							window.location.href = "/index.php?m=Mobile&c=Cart&a=cart4&order_id=" + res.data.order_id;
						}else{
							layer.msg(res.msg);
						}
					},
					error:function(){
						layer.msg('请重新上传');
					}
				});
			});
		});
	$(function(){
		$("#total").bind('DOMNodeInserted',function(){
			var total = $("#total").html();
			var profit_cons_beans = $("#profit_cons_beans").val();
			var num = Math.ceil(parseInt(total.substring(1).substring(1).substring(1).substring(1)) * (profit_cons_beans / 100));
			document.getElementById("ywd").innerHTML = "消耗悦玩豆:" + num + "个";
		});
	});
	$("#pic").click(function(){
		var number = $("#number").html();
		var pic_price = $("#pic_price").val();
		var total = number * pic_price;
		document.getElementById("total").innerHTML = "总计:￥" + total + ".0";
	});
	$("#video").click(function(){
		var number = $("#number").html();
		var video_price = $("#video_price").val();
		var total = number * video_price;
		document.getElementById("total").innerHTML = "总计:￥" + total + ".0";
	});
	$("#dec").click(function(){
		var number = $("#number").html();
		var pic_price = $("#pic_price").val();
		var video_price = $("#video_price").val();
		var type_value = $(".current").html();
		var type;
		if(type_value == '图片广告'){
			type = 1;
		}else{
			type = 2;
		}
		var total;
		if(type == 1){
			total = number * pic_price;
		}else{
			total = number * video_price;
		}
		document.getElementById("total").innerHTML = "总计:￥" + total + ".0";
	});
		$("#inc").click(function(){
			var number = $("#number").html();
			var pic_price = $("#pic_price").val();
			var video_price = $("#video_price").val();
			var type_value = $(".current").html();
			var type;
			if(type_value == '图片广告'){
				type = 1;
			}else{
				type = 2;
			}
			var total;
			if(type == 1){
				total = number * pic_price;
			}else{
				total = number * video_price;
			}
			document.getElementById("total").innerHTML = "总计:￥" + total + ".0";
		});
	</script>
</html>
